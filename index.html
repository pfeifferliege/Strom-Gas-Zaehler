<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energie-Kostenrechner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom font and scroll behavior */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* Custom styles for input fields */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Style for select dropdown arrows */
        select {
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            background-repeat: no-repeat;
        }

        /* Dynamische CSS-Variablen f√ºr das saisonale Design */
        :root {
            --season-primary: #1e40af; /* Default: Blue-700 */
            --season-icon: #3b82f6; /* Default: Blue-500 */
            --season-ring: #2563eb; /* Default: Blue-600 */
        }

        /* Anwenden der Variablen auf Tailwind-√§hnliche Klassen */
        .seasonal-bg-primary { background-color: var(--season-primary); }
        .seasonal-hover-bg-primary:hover { background-color: var(--season-primary); }
        .seasonal-icon-primary { color: var(--season-icon); }
        .seasonal-focus-ring { --tw-ring-color: var(--season-ring); }
        .seasonal-border-primary { border-color: var(--season-icon); }
    </style>
</head>
<body class="bg-gray-50 text-slate-800" onload="initApp()">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-slate-900 drop-shadow-sm">Energie-Dashboard ‚ö°üè°</h1>
            <p class="text-slate-600 mt-2 text-lg">Behalten Sie den √úberblick √ºber Ihre Strom- & Gaskosten.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-1 space-y-8">
                
                <div class="bg-white p-7 rounded-3xl shadow-xl border border-slate-200">
                    <button type="button" onclick="toggleSettings()" class="w-full flex justify-between items-center text-left">
                        <h2 class="text-2xl font-bold flex items-center seasonal-icon-primary"><i class="fas fa-cog mr-3"></i>Einstellungen</h2>
                        <i id="settings-chevron" class="fas fa-chevron-down text-slate-500 transition-transform duration-300"></i>
                    </button>
                    <div id="settings-content" class="mt-5 pt-5 border-t border-slate-200 hidden">
                        <form id="settings-form" class="space-y-4 text-sm">
                           <div>
                                <label for="monthly-payment" class="block font-medium text-slate-700">Monatlicher Abschlag (‚Ç¨) <span class="text-xs text-red-500 font-normal">(F√ºr L√ºcken hier aufschlagen!)</span></label>
                                <input type="number" step="any" id="monthly-payment" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-xl p-3 focus:ring-1 seasonal-focus-ring">
                           </div>
                           <div>
                                <label for="strom-tariff-select" class="block font-medium text-slate-700">Ihr Stromtarif</label>
                                <select id="strom-tariff-select" onchange="saveSettings()" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-xl p-3 appearance-none focus:ring-1 seasonal-focus-ring"></select>
                           </div>
                           <div>
                                <label for="gas-tariff-select" class="block font-medium text-slate-700">Ihr Gastarif</label>
                                <select id="gas-tariff-select" onchange="saveSettings()" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-xl p-3 appearance-none focus:ring-1 seasonal-focus-ring"></select>
                           </div>
                           <div id="gas-faktor-block" class="hidden">
                                <label for="gas-faktor" class="block font-medium text-slate-700">Umrechnungsfaktor Gas (m¬≥ ‚Üí kWh)</label>
                                <input type="number" step="any" id="gas-faktor" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-xl p-3 focus:ring-1 seasonal-focus-ring">
                           </div>

                           <button type="button" onclick="saveSettings()" class="w-full bg-slate-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition shadow-md">
                                <i class="fas fa-cogs mr-2"></i> Einstellungen Speichern
                           </button>
                           
                           <div class="pt-4 border-t border-slate-200">
                               <button type="button" onclick="clearAllData()" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-xl hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400 transition text-sm shadow-md">
                                    <i class="fas fa-exclamation-triangle mr-1"></i> Monatsdaten L√∂schen
                               </button>
                               <button type="button" onclick="clearYearlyData()" class="w-full mt-2 bg-red-400 text-white font-bold py-2 px-4 rounded-xl hover:bg-red-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-300 transition text-sm shadow-md">
                                    <i class="fas fa-archive mr-1"></i> Gespeicherte Jahresbilanzen L√∂schen
                               </button>
                           </div>
                        </form>
                    </div>
                </div>

                <div class="bg-white p-7 rounded-3xl shadow-xl border border-slate-200">
                    <h2 class="text-2xl font-bold mb-5 flex items-center seasonal-icon-primary"><i class="fas fa-plus-circle mr-3"></i>Neuer Eintrag</h2>
                    <div id="error-message" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm font-medium border border-red-300"></div>
                    <form id="entry-form" class="space-y-5">
                        <div>
                            <label for="entry-month" class="block text-sm font-medium text-slate-700">Monat & Jahr</label>
                            <input type="month" id="entry-month" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-xl p-3 focus:ring-2 seasonal-focus-ring focus:border-transparent transition duration-200">
                        </div>
                        
                        <fieldset id="fieldset-strom" class="border-t border-slate-200 pt-5">
                            <legend class="font-semibold text-slate-700 flex items-center"><i class="fas fa-bolt mr-2 text-yellow-500"></i>Strom (kWh)</legend>
                            <div class="grid grid-cols-2 gap-4 mt-3">
                                <div>
                                    <label for="strom-start" class="block text-xs text-slate-500">Vormonat (Z√§hlerstand)</label>
                                    <input type="number" step="any" id="strom-start" placeholder="z.B. 15000" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-xl p-3 text-sm focus:ring-1 seasonal-focus-ring">
                                </div>
                                <div>
                                    <label for="strom-end" class="block text-xs text-slate-500">Aktuell (Z√§hlerstand)</label>
                                    <input type="number" step="any" id="strom-end" placeholder="z.B. 15200" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-xl p-3 text-sm focus:ring-1 seasonal-focus-ring">
                                </div>
                            </div>
                        </fieldset>

                        <fieldset id="fieldset-gas" class="border-t border-slate-200 pt-5">
                            <legend class="font-semibold text-slate-700 flex items-center"><i class="fas fa-fire mr-2 text-orange-500"></i>Gas (m¬≥)</legend>
                            <div class="grid grid-cols-2 gap-4 mt-3">
                                <div>
                                    <label for="gas-start" class="block text-xs text-slate-500">Vormonat (Z√§hlerstand)</label>
                                    <input type="number" step="any" id="gas-start" placeholder="z.B. 8000" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-xl p-3 text-sm focus:ring-1 seasonal-focus-ring">
                                </div>
                                <div>
                                    <label for="gas-end" class="block text-xs text-slate-500">Aktuell (Z√§hlerstand)</label>
                                    <input type="number" step="any" id="gas-end" placeholder="z.g. 8150" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-xl p-3 text-sm focus:ring-1 seasonal-focus-ring">
                                </div>
                            </div>
                        </fieldset>
                        
                        <p id="no-tariff-active-hint" class="text-sm text-center text-red-500 font-medium hidden">‚ö†Ô∏è Bitte w√§hlen Sie in den Einstellungen einen Tarif, um Z√§hlerst√§nde einzugeben.</p>


                        <button type="button" onclick="addEntry()" class="w-full seasonal-bg-primary text-white font-extrabold py-3 px-4 rounded-xl seasonal-hover-bg-primary focus:outline-none focus:ring-4 seasonal-focus-ring focus:ring-opacity-50 transition-transform transform hover:scale-[1.02] shadow-lg mt-6">
                            <i class="fas fa-save mr-2"></i> Eintrag Speichern
                        </button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                
                <div class="bg-white p-7 rounded-3xl shadow-xl border border-slate-200">
                    
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3">
                        <h2 class="text-2xl font-bold flex items-center seasonal-icon-primary mb-2 sm:mb-0"><i class="fas fa-chart-pie mr-3"></i>Jahres√ºbersicht</h2>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-5 border-b pb-4 border-slate-100">
                        <span id="current-year-display" class="text-slate-500 text-xl font-semibold mb-2 sm:mb-0"></span>
                        <button type="button" onclick="saveCurrentSummaryAsYear()" class="w-full sm:w-auto bg-indigo-500 text-white font-bold py-1 px-3 rounded-xl hover:bg-indigo-600 text-sm transition-transform transform hover:scale-[1.02] shadow-md">
                            <i class="fas fa-history mr-1"></i> Bilanz Speichern
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                        <div class="bg-slate-50 p-4 rounded-xl border-t-4 seasonal-border-primary border-opacity-70">
                            <p class="text-sm text-slate-600 font-medium">Gesamtkosten</p>
                            <p id="summary-total-costs" class="text-3xl font-extrabold text-slate-800 mt-1">0,00 ‚Ç¨</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border-t-4 border-indigo-400 border-opacity-70">
                            <p class="text-sm text-slate-600 font-medium">Gezahlte Abschl√§ge</p>
                            <p id="summary-paid" class="text-3xl font-extrabold text-slate-800 mt-1">0,00 ‚Ç¨</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border-t-4 border-green-500 border-opacity-70">
                            <p class="text-sm text-slate-600 font-medium">Bilanz</p>
                            <p id="summary-balance" class="text-3xl font-extrabold text-green-600 mt-1">0,00 ‚Ç¨</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-6 text-sm">
                        <div id="summary-strom-block" class="p-3 bg-yellow-50 rounded-xl border border-yellow-300">
                            <p class="font-bold flex items-center text-slate-700"><i class="fas fa-bolt mr-2 text-yellow-500 text-lg"></i>Stromkosten Gesamt</p>
                            <p id="summary-strom" class="text-xl font-extrabold text-slate-800 mt-1">0,00 ‚Ç¨</p>
                        </div>
                        <div id="summary-gas-block" class="p-3 bg-orange-50 rounded-xl border border-orange-300">
                            <p class="font-bold flex items-center text-slate-700"><i class="fas fa-fire mr-2 text-orange-500 text-lg"></i>Gaskosten Gesamt</p>
                            <p id="summary-gas" class="text-xl font-extrabold text-slate-800 mt-1">0,00 ‚Ç¨</p>
                        </div>
                    </div>

                    <div id="comparison-section" class="mt-8 pt-5 border-t border-slate-200 hidden">
                        <label for="yearly-comparison-select" class="block font-medium text-slate-700 mb-2 flex items-center">
                             <i class="fas fa-balance-scale mr-2 text-slate-500"></i>Jahresvergleich
                        </label>
                        <select id="yearly-comparison-select" onchange="renderComparison()" class="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-xl p-3 appearance-none focus:ring-1 seasonal-focus-ring"></select>
                        <div id="comparison-display" class="mt-4 p-4 rounded-xl border border-dashed border-slate-300 bg-slate-50 text-sm">
                             <p class="text-slate-500">W√§hlen Sie ein Jahr zum Vergleich aus.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-7 rounded-3xl shadow-xl border border-slate-200">
                    <h2 class="text-2xl font-bold mb-5 flex items-center seasonal-icon-primary"><i class="fas fa-history mr-3"></i>Monats-Verlauf</h2>
                    <div id="history-container" class="space-y-4">
                        <p id="no-entries" class="text-slate-500 text-center py-8">Noch keine Eintr√§ge vorhanden. ü§ì</p>
                        </div>
                </div>
            </div>
        </div>
    </div>

<script>
// --- TARIFF DATA ---
// All prices converted from ct/kWh to ‚Ç¨/kWh
const TARIFF_DATA = {
    strom: {
        'klima-classic': { name: 'Klima Classic', arbeitspreis: 0.3928, grundpreis: 14.99 },
        'klima-service-flex': { name: 'Klima Service Flex', arbeitspreis: 0.3714, grundpreis: 13.33 },
        'klima-nacht-8-0': { name: 'Klima Nacht Flex (8+0)', arbeitspreis: 0.3131, grundpreis: 10.25 },
        'klima-nacht-8-2': { name: 'Klima Nacht Flex (8+2)', arbeitspreis: 0.3159, grundpreis: 10.25 },
        'klima-nacht-8-4': { name: 'Klima Nacht Flex (8+4)', arbeitspreis: 0.3211, grundpreis: 10.25 },
        'klima-regio-a': { name: 'Klima Regio-A-Flex', arbeitspreis: 0.3516, grundpreis: 12.79 },
        'klima-regio-m': { name: 'Klima Regio-M-Flex', arbeitspreis: 0.3334, grundpreis: 12.65 },
        'klima-wp-ht': { name: 'Klima W√§rmepumpe (HT)', arbeitspreis: 0.3076, grundpreis: 10.75 },
        'klima-wp-nt': { name: 'Klima W√§rmepumpe (NT)', arbeitspreis: 0.2974, grundpreis: 2.28 },
    },
    gas: {
        'erdgas-classic': { 
            name: 'Erdgas Classic',
            tiers: [
                { bis: 2700, arbeitspreis: 0.1896, grundpreis: 3.75 },
                { bis: 13000, arbeitspreis: 0.1612, grundpreis: 13.75 },
                { bis: 65400, arbeitspreis: 0.1490, grundpreis: 31.25 },
                { bis: Infinity, arbeitspreis: 0.1547, grundpreis: 0.00 },
            ]
        },
        'erdgas-service-flex': {
            name: 'Erdgas Service Flex',
            tiers: [
                { bis: 2700, arbeitspreis: 0.1711, grundpreis: 3.00 },
                { bis: 13000, arbeitspreis: 0.1434, grundpreis: 12.25 },
                { bis: 65400, arbeitspreis: 0.1309, grundpreis: 29.00 },
                { bis: Infinity, arbeitspreis: 0.1361, grundpreis: 0.00 },
            ]
        }
    }
};

// --- CONFIG & STATE ---
const NO_TARIFF_SELECTED = 'no-tariff';

const DEFAULT_SETTINGS = {
    monthlyPayment: 266,
    gasFaktor: 10.5,
    stromTariff: NO_TARIFF_SELECTED,
    gasTariff: NO_TARIFF_SELECTED
};

let appState = {
    settings: { ...DEFAULT_SETTINGS },
    entries: [],
    yearlySummaries: {}
};

// --- SEASONAL DESIGN LOGIC ---
function getSeasonColors() {
    const month = new Date().getMonth() + 1;
    if (month >= 3 && month <= 5) { return { primary: '#10b981', icon: '#059669', ring: '#34d399' }; }
    else if (month >= 6 && month <= 8) { return { primary: '#f97316', icon: '#ea580c', ring: '#fb923c' }; }
    else if (month >= 9 && month <= 11) { return { primary: '#b91c1c', icon: '#991b1b', ring: '#f87171' }; }
    else { return { primary: '#0369a1', icon: '#0369a1', ring: '#38bdf8' }; }
}

function applySeasonalDesign() {
    const colors = getSeasonColors();
    const root = document.documentElement;
    root.style.setProperty('--season-primary', colors.primary);
    root.style.setProperty('--season-icon', colors.icon);
    root.style.setProperty('--season-ring', colors.ring);
}


// --- INITIALIZATION ---
function initApp() {
    applySeasonalDesign();
    loadStateFromLocalStorage();
    populateTariffDropdowns();
    applySettingsToUI();
    toggleInputFields(); 
    // Initiales Rendern des geladenen Zustands
    render(); 
    populateComparisonDropdown();
    
    // Setzt das Eingabefeld auf den aktuellen Monat, falls noch kein Eintrag
    if (appState.entries.length === 0) {
        setEntryMonthToCurrent();
    }
}

function setEntryMonthToCurrent() {
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    document.getElementById('entry-month').value = `${year}-${month}`;
}

function populateTariffDropdowns() {
    const stromSelect = document.getElementById('strom-tariff-select');
    const gasSelect = document.getElementById('gas-tariff-select');

    const createNoTariffOption = () => {
        const option = document.createElement('option');
        option.value = NO_TARIFF_SELECTED;
        option.textContent = 'Bitte Tarif w√§hlen (Kein Verbrauch)';
        return option;
    };

    stromSelect.innerHTML = '';
    stromSelect.appendChild(createNoTariffOption());
    for (const key in TARIFF_DATA.strom) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = TARIFF_DATA.strom[key].name;
        stromSelect.appendChild(option);
    }

    gasSelect.innerHTML = '';
    gasSelect.appendChild(createNoTariffOption());
    for (const key in TARIFF_DATA.gas) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = TARIFF_DATA.gas[key].name;
        gasSelect.appendChild(option);
    }
}

// --- DATA HANDLING (LocalStorage) ---
function loadStateFromLocalStorage() {
    const savedSettings = localStorage.getItem('energyAppSettings');
    const savedEntries = localStorage.getItem('energyAppEntries');
    const savedYearlySummaries = localStorage.getItem('energyAppYearlySummaries');

    if (savedSettings) {
        const loadedSettings = JSON.parse(savedSettings);
        appState.settings = { 
            ...DEFAULT_SETTINGS, 
            ...loadedSettings,
            stromTariff: loadedSettings.stromTariff || DEFAULT_SETTINGS.stromTariff,
            gasTariff: loadedSettings.gasTariff || DEFAULT_SETTINGS.gasTariff,
        };
    }
    if (savedEntries) {
        appState.entries = JSON.parse(savedEntries);
        // HINWEIS: Alte Eintr√§ge, die noch kein 'monthlyPayment' Feld haben, werden im renderHistory() mit dem aktuellen Wert behandelt.
    }
    if (savedYearlySummaries) {
        appState.yearlySummaries = JSON.parse(savedYearlySummaries);
    }
}

function saveStateToLocalStorage() {
    localStorage.setItem('energyAppSettings', JSON.stringify(appState.settings));
    localStorage.setItem('energyAppEntries', JSON.stringify(appState.entries));
    localStorage.setItem('energyAppYearlySummaries', JSON.stringify(appState.yearlySummaries));
}

// --- DYNAMIC UI CONTROL ---
function toggleInputFields() {
    const isStromActive = appState.settings.stromTariff !== NO_TARIFF_SELECTED;
    const isGasActive = appState.settings.gasTariff !== NO_TARIFF_SELECTED;
    
    document.getElementById('fieldset-strom').classList.toggle('hidden', !isStromActive);
    document.getElementById('fieldset-gas').classList.toggle('hidden', !isGasActive);
    document.getElementById('gas-faktor-block').classList.toggle('hidden', !isGasActive);
    document.getElementById('no-tariff-active-hint').classList.toggle('hidden', isStromActive || isGasActive);
    document.getElementById('summary-strom-block').classList.toggle('hidden', !isStromActive);
    document.getElementById('summary-gas-block').classList.toggle('hidden', !isGasActive);
}

// --- UI & RENDERING ---
function render() {
    // Stellt sicher, dass alle Kosten mit dem aktuellen Tarif/Abschlag neu berechnet werden, falls Einstellungen ge√§ndert wurden
    recalculateAllEntries(); 
    renderHistory();
    renderSummary();
    prefillNextEntry(); 
    populateComparisonDropdown(); 
    renderComparison();
}

function renderHistory() {
    const container = document.getElementById('history-container');
    const noEntriesMessage = document.getElementById('no-entries');
    container.innerHTML = ''; 

    if (appState.entries.length === 0) {
        if (!document.getElementById('no-entries')) {
            container.appendChild(noEntriesMessage);
        }
        noEntriesMessage.classList.remove('hidden');
        return;
    }
    
    noEntriesMessage.classList.add('hidden');

    // Sortiere nach ID (Jahr-Monat) absteigend f√ºr die Anzeige
    const sortedEntries = [...appState.entries].sort((a, b) => b.id.localeCompare(a.id));
    
    sortedEntries.forEach(entry => {
        // GE√ÑNDERT: Verwende den gespeicherten Abschlagswert f√ºr die Monatsbilanz. 
        // Fallback f√ºr alte Eintr√§ge, die das Feld noch nicht haben.
        const paymentForThisMonth = entry.monthlyPayment !== undefined 
                                   ? entry.monthlyPayment 
                                   : appState.settings.monthlyPayment;
                                   
        const balance = entry.totalCosts - paymentForThisMonth;
        const isNachzahlung = balance > 0;
        const balanceColor = isNachzahlung ? 'text-red-600' : 'text-green-600';
        const balanceText = isNachzahlung ? 'Nachzahlung' : 'Guthaben';
        
        const isEntryStromActive = entry.strom.verbrauch > 0 || entry.strom.kosten > 0;
        const isEntryGasActive = entry.gas.verbrauchM3 > 0 || entry.gas.kosten > 0;

        const stromHtml = isEntryStromActive ? `
            <div>
                <p class="font-semibold flex items-center"><i class="fas fa-bolt mr-2 text-yellow-500"></i>Strom</p>
                <p>Verbrauch: <span class="font-medium">${entry.strom.verbrauch.toFixed(2)} kWh</span></p>
                <p>Kosten: <span class="font-medium">${formatCurrency(entry.strom.kosten, true)}</span></p>
            </div>
        ` : '';

        const gasHtml = isEntryGasActive ? `
            <div>
                <p class="font-semibold flex items-center"><i class="fas fa-fire mr-2 text-orange-500"></i>Gas</p>
                <p>Verbrauch: <span class="font-medium">${entry.gas.verbrauchM3.toFixed(2)} m¬≥ (${entry.gas.verbrauchKWh.toFixed(2)} kWh)</span></p>
                <p>Kosten: <span class="font-medium">${formatCurrency(entry.gas.kosten, true)}</span></p>
            </div>
        ` : '';
        
        const gridClass = (isEntryStromActive && isEntryGasActive) ? 'grid-cols-2' : 'grid-cols-1';


        const entryElement = document.createElement('div');
        entryElement.className = 'bg-slate-50 p-4 rounded-xl border-l-4 seasonal-border-primary border-opacity-50 transition hover:shadow-lg';
        entryElement.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-bold text-xl text-slate-900">${entry.monthName} ${entry.year}</p>
                    <p class="text-sm font-semibold text-slate-600">
                        Gesch√§tzte Kosten: <span class="${entry.totalCosts > paymentForThisMonth ? 'text-red-500' : 'text-green-500'}">${formatCurrency(entry.totalCosts, true)}</span>
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-lg font-extrabold ${balanceColor}">${balanceText}: ${formatCurrency(Math.abs(balance), true)}</p>
                    <p class="text-xs text-slate-500">Abschlag: ${formatCurrency(paymentForThisMonth)}</p>
                    <button onclick="deleteEntry('${entry.id}')" class="text-slate-400 hover:text-red-600 text-xs mt-2 transition">
                        <i class="fas fa-trash-alt mr-1"></i> L√∂schen
                    </button>
                </div>
            </div>
            <div class="mt-3 pt-3 border-t border-slate-200 grid ${gridClass} gap-4 text-xs text-slate-600">
                ${stromHtml}
                ${gasHtml}
            </div>
        `;
        container.appendChild(entryElement);
    });
}

function renderSummary() {
    const currentYear = new Date().getFullYear();
    document.getElementById('current-year-display').textContent = `Aktuelles Jahr: ${currentYear}`;
    
    // Filtriert Eintr√§ge f√ºr das aktuelle Jahr
    const currentYearEntries = appState.entries.filter(e => e.year === currentYear);

    const totalStromCosts = currentYearEntries.reduce((sum, entry) => sum + entry.strom.kosten, 0);
    const totalGasCosts = currentYearEntries.reduce((sum, entry) => sum + entry.gas.kosten, 0);
    const totalCosts = totalStromCosts + totalGasCosts;
    
    // Summe der gespeicherten Abschl√§ge
    const totalPaid = currentYearEntries.reduce((sum, entry) => sum + (entry.monthlyPayment !== undefined ? entry.monthlyPayment : appState.settings.monthlyPayment), 0);
    
    const balance = totalPaid - totalCosts;

    document.getElementById('summary-strom').textContent = formatCurrency(totalStromCosts, true);
    document.getElementById('summary-gas').textContent = formatCurrency(totalGasCosts, true);
    document.getElementById('summary-total-costs').textContent = formatCurrency(totalCosts, true);
    document.getElementById('summary-paid').textContent = formatCurrency(totalPaid, true);
    
    const balanceEl = document.getElementById('summary-balance');
    balanceEl.textContent = formatCurrency(balance, true);
    balanceEl.classList.toggle('text-green-600', balance >= 0);
    balanceEl.classList.toggle('text-red-600', balance < 0);
}

function populateComparisonDropdown() {
    const select = document.getElementById('yearly-comparison-select');
    const currentYear = new Date().getFullYear().toString();
    const years = Object.keys(appState.yearlySummaries).sort().reverse();
    
    select.innerHTML = '<option value="">Kein Vergleich</option>';
    
    let hasEntries = false;
    years.forEach(year => {
        if (year !== currentYear.toString()) { 
            const option = document.createElement('option');
            option.value = year;
            option.textContent = `Bilanz ${year}`;
            select.appendChild(option);
            hasEntries = true;
        }
    });
    
    document.getElementById('comparison-section').classList.toggle('hidden', !hasEntries);
}

function renderComparison() {
    const selectedYear = document.getElementById('yearly-comparison-select').value;
    const display = document.getElementById('comparison-display');
    
    if (!selectedYear || !appState.yearlySummaries[selectedYear]) {
        display.innerHTML = '<p class="text-slate-500">W√§hlen Sie ein Jahr zum Vergleich aus.</p>';
        return;
    }
    
    const summary = appState.yearlySummaries[selectedYear];
    const balanceColor = summary.balance >= 0 ? 'text-green-600' : 'text-red-600';
    const balanceText = summary.balance >= 0 ? 'Guthaben' : 'Nachzahlung';

    display.innerHTML = `
        <p class="font-bold text-lg text-slate-800 mb-2">Vergleich: Bilanz ${selectedYear}</p>
        <div class="grid grid-cols-2 gap-3 text-xs">
            <div class="p-2 bg-slate-100 rounded-lg">
                <p class="font-medium text-slate-600">Gesamtkosten:</p>
                <p class="font-extrabold text-slate-800">${formatCurrency(summary.totalCosts)}</p>
            </div>
             <div class="p-2 bg-slate-100 rounded-lg">
                <p class="font-medium text-slate-600">Abschl√§ge:</p>
                <p class="font-extrabold text-slate-800">${formatCurrency(summary.totalPaid)}</p>
            </div>
            <div class="col-span-2 p-2 rounded-lg ${summary.balance >= 0 ? 'bg-green-100' : 'bg-red-100'}">
                <p class="font-medium text-slate-600">Endbilanz:</p>
                <p class="font-extrabold ${balanceColor} text-base">${balanceText}: ${formatCurrency(Math.abs(summary.balance))}</p>
            </div>
        </div>
        <p class="text-xs text-slate-500 mt-2">(${summary.months} Monat${summary.months !== 1 ? 'e' : ''} erfasst)</p>
    `;
}

function saveCurrentSummaryAsYear() {
    const currentYear = new Date().getFullYear();
    const currentYearEntries = appState.entries.filter(e => e.year === currentYear);
    
    if (currentYearEntries.length === 0) {
        alert("Es sind noch keine Monats-Eintr√§ge f√ºr dieses Jahr vorhanden, um eine Bilanz zu speichern.");
        return;
    }
    
    if (appState.yearlySummaries[currentYear]) {
        if (!confirm(`Die Jahresbilanz f√ºr ${currentYear} existiert bereits. √úberschreiben?`)) {
            return;
        }
    }
    
    const totalStromCosts = currentYearEntries.reduce((sum, entry) => sum + entry.strom.kosten, 0);
    const totalGasCosts = currentYearEntries.reduce((sum, entry) => sum + entry.gas.kosten, 0);
    const totalCosts = totalStromCosts + totalGasCosts;
    // Summe der gespeicherten Abschl√§ge
    const totalPaid = currentYearEntries.reduce((sum, entry) => sum + (entry.monthlyPayment !== undefined ? entry.monthlyPayment : appState.settings.monthlyPayment), 0);
    const balance = totalPaid - totalCosts;

    appState.yearlySummaries[currentYear] = {
        totalCosts: totalCosts,
        totalPaid: totalPaid,
        balance: balance,
        months: currentYearEntries.length,
        stromCosts: totalStromCosts,
        gasCosts: totalGasCosts
    };
    
    saveAndRerender();
    alert(`Jahresbilanz f√ºr ${currentYear} gespeichert!`);
}

function prefillNextEntry() {
    
    const stromStartEl = document.getElementById('strom-start');
    const gasStartEl = document.getElementById('gas-start');
    const stromEndEl = document.getElementById('strom-end');
    const gasEndEl = document.getElementById('gas-end');
    const monthInputEl = document.getElementById('entry-month');

    // 1. Zuerst alle Z√§hlerstand-Endfelder leeren
    stromEndEl.value = '';
    gasEndEl.value = '';
    
    if (appState.entries.length > 0) {
        // Da addEntry() das Array sofort nach Hinzuf√ºgen sortiert, ist der letzte Eintrag der aktuellste
        const lastEntry = appState.entries[appState.entries.length - 1]; 
        
        // 2. Z√§hlerst√§nde vorf√ºllen
        
        if (appState.settings.stromTariff !== NO_TARIFF_SELECTED && lastEntry.strom.end > 0) {
            // F√ºllt den Startwert mit dem Endwert des letzten Eintrags
            stromStartEl.value = lastEntry.strom.end; 
        } else {
            stromStartEl.value = '';
        }
        
        if (appState.settings.gasTariff !== NO_TARIFF_SELECTED && lastEntry.gas.end > 0) {
            // F√ºllt den Startwert mit dem Endwert des letzten Eintrags
            gasStartEl.value = lastEntry.gas.end;
        } else {
            gasStartEl.value = '';
        }

        // 3. Datum auf den n√§chsten Monat setzen
        const [lastYear, lastMonth] = lastEntry.id.split('-').map(Number);
        const lastDate = new Date(lastYear, lastMonth - 1, 1); 
        lastDate.setMonth(lastDate.getMonth() + 1); 

        const nextYear = lastDate.getFullYear();
        const nextMonth = (lastDate.getMonth() + 1).toString().padStart(2, '0'); 
        
        const nextEntryMonthValue = `${nextYear}-${nextMonth}`;
        
        monthInputEl.value = nextEntryMonthValue;

    } else {
        // Bei erstem Eintrag: Startfelder leer lassen, Datum auf aktuellen Monat setzen
        stromStartEl.value = '';
        gasStartEl.value = '';
        setEntryMonthToCurrent();
    }
}


// --- ACTIONS & EVENT HANDLERS ---
function addEntry() {
    const monthInput = document.getElementById('entry-month').value;
    const stromStart = parseFloat(document.getElementById('strom-start').value);
    const stromEnd = parseFloat(document.getElementById('strom-end').value);
    const gasStart = parseFloat(document.getElementById('gas-start').value);
    const gasEnd = parseFloat(document.getElementById('gas-end').value);

    const stromTariffKey = appState.settings.stromTariff;
    const gasTariffKey = appState.settings.gasTariff;
    const stromTariffSelected = stromTariffKey !== NO_TARIFF_SELECTED;
    const gasTariffSelected = gasTariffKey !== NO_TARIFF_SELECTED;

    if (!monthInput || (!stromTariffSelected && !gasTariffSelected)) {
        showError("Bitte f√ºllen Sie das Datum aus und w√§hlen Sie mindestens einen Tarif in den Einstellungen.");
        return;
    }

    const hasValidStromData = stromTariffSelected && !isNaN(stromStart) && !isNaN(stromEnd);
    const hasValidGasData = gasTariffSelected && !isNaN(gasStart) && !isNaN(gasEnd);

    if (stromTariffSelected && !hasValidStromData) {
        showError("Strom: Bitte f√ºllen Sie Start- und Endstand korrekt aus.");
        return;
    }
    
    if (gasTariffSelected && !hasValidGasData) {
        showError("Gas: Bitte f√ºllen Sie Start- und Endstand korrekt aus.");
        return;
    }

    if (hasValidStromData && stromEnd < stromStart) {
        showError("Strom: Der aktuelle Z√§hlerstand muss h√∂her sein als der Vormonatsstand.");
        return;
    }
    if (hasValidGasData && gasEnd < gasStart) {
        showError("Gas: Der aktuelle Z√§hlerstand muss h√∂her sein als der Vormonatsstand.");
        return;
    }
    
    const entryId = monthInput;
    if (appState.entries.some(e => e.id === entryId)) {
        showError(`Ein Eintrag f√ºr diesen Monat (${entryId}) existiert bereits. Bitte w√§hlen Sie den n√§chsten Monat.`);
        return;
    }
    hideError();

    // --- STROM Calculations ---
    let stromVerbrauch = 0;
    let stromKosten = 0;
    if (hasValidStromData) {
        const stromTariff = TARIFF_DATA.strom[stromTariffKey];
        stromVerbrauch = stromEnd - stromStart;
        // Grundpreis monatlich
        stromKosten = (stromVerbrauch * stromTariff.arbeitspreis) + (stromTariff.grundpreis / 12); 
    }

    // --- GAS Calculations ---
    let gasVerbrauchM3 = 0;
    let gasVerbrauchKWh = 0;
    let gasKosten = 0;
    if (hasValidGasData) {
        const gasTariffData = TARIFF_DATA.gas[gasTariffKey];
        gasVerbrauchM3 = gasEnd - gasStart;
        gasVerbrauchKWh = gasVerbrauchM3 * appState.settings.gasFaktor;
        
        // Berechne den aktuellen Jahresverbrauch f√ºr die Tier-Stufe
        const currentEntriesCount = appState.entries.length;
        // Wir m√ºssen alle vorhandenen Eintr√§ge + den neuen Eintrag in die Berechnung einbeziehen.
        const totalGasKWhSoFar = appState.entries.reduce((sum, e) => sum + e.gas.verbrauchKWh, 0) + gasVerbrauchKWh;
        const estimatedAnnualKWh = (totalGasKWhSoFar / (currentEntriesCount + 1)) * 12;
        
        const gasTier = gasTariffData.tiers.find(t => estimatedAnnualKWh <= t.bis);
        
        // Grundpreis monatlich
        gasKosten = (gasVerbrauchKWh * gasTier.arbeitspreis) + (gasTier.grundpreis / 12); 
    }

    const [year, month] = monthInput.split('-');
    const monthName = new Date(year, month - 1, 1).toLocaleString('de-DE', { month: 'long' });

    const newEntry = {
        id: entryId, year: parseInt(year), month: parseInt(month), monthName: monthName,
        // Speichert den aktuellen Abschlag, wie er gerade in den Einstellungen steht (dies ist der korrigierte Wert)
        monthlyPayment: appState.settings.monthlyPayment, 
        strom: { 
            start: hasValidStromData ? stromStart : 0, 
            end: hasValidStromData ? stromEnd : 0, 
            verbrauch: stromVerbrauch, 
            kosten: stromKosten 
        },
        gas: { 
            start: hasValidGasData ? gasStart : 0, 
            end: hasValidGasData ? gasEnd : 0, 
            verbrauchM3: gasVerbrauchM3, 
            verbrauchKWh: gasVerbrauchKWh, 
            kosten: gasKosten 
        },
        totalCosts: stromKosten + gasKosten,
    };

    appState.entries.push(newEntry);
    
    // Sortiere die Eintr√§ge sofort chronologisch (A-Z auf ID), damit prefillNextEntry den korrekten letzten Eintrag findet
    appState.entries.sort((a, b) => a.id.localeCompare(b.id));
    
    // 1. Hole den Standard-Abschlag aus den gespeicherten Settings (vor der tempor√§ren √Ñnderung)
    const savedSettingsString = localStorage.getItem('energyAppSettings');
    let storedMonthlyPayment = DEFAULT_SETTINGS.monthlyPayment;

    if (savedSettingsString) {
        const parsedSettings = JSON.parse(savedSettingsString);
        // Hier muss der *urspr√ºngliche* regul√§re Abschlag geholt werden, der nicht der gerade eingegebene (korrigierte) Wert ist.
        // Da saveSettings() und loadStateFromLocalStorage() nur den Wert aus dem Input-Feld verwenden, m√ºssen wir hier einen kleinen Umweg gehen, 
        // um den Wert auf den urspr√ºnglichen Standard-Abschlag zur√ºckzusetzen, der in den Settings persistiert ist, falls er tempor√§r erh√∂ht wurde.
        // Da die Abschlagszahlung jetzt *im Eintrag* gespeichert ist, k√∂nnen wir den globalen Wert einfach auf den zuletzt gespeicherten Standardwert zur√ºcksetzen.
        
        // Da der Code keine separate Speicherung f√ºr den "Standard"-Abschlag hat, nutzen wir den Wert, 
        // der kurz vor dem Speichern in appState.settings.monthlyPayment stand, um ihn in den Eintrag zu √ºbernehmen.
        // Um das Eingabefeld zur√ºckzusetzen, setzen wir es auf den Wert aus dem localStorage, wenn es existiert.
        
        // NEU: Nur das Eingabefeld f√ºr den Endstand zur√ºcksetzen, damit prefillNextEntry die Felder korrekt belegt.
        document.getElementById('strom-end').value = '';
        document.getElementById('gas-end').value = '';
        
        // Setze den globalen Abschlag in den Einstellungen NICHT zur√ºck, damit der Nutzer ihn manuell anpassen kann.
        // Der wichtige Teil ist, dass der korrigierte Wert im Eintrag gespeichert wurde.

    } else {
        // Bei erstem Eintrag: Zur√ºcksetzen auf Default
        appState.settings.monthlyPayment = DEFAULT_SETTINGS.monthlyPayment;
        document.getElementById('monthly-payment').value = DEFAULT_SETTINGS.monthlyPayment;
    }

    saveAndRerender();
}

function deleteEntry(entryId) {
    if (confirm("Diesen Eintrag wirklich l√∂schen?")) {
        appState.entries = appState.entries.filter(entry => entry.id !== entryId);
        // Nach dem L√∂schen neu sortieren
        appState.entries.sort((a, b) => a.id.localeCompare(b.id)); 
        saveAndRerender();
    }
}

function saveSettings() {
    // Speichert den Wert, wie er gerade im Feld steht.
    appState.settings.monthlyPayment = parseFloat(document.getElementById('monthly-payment').value) || 0;
    appState.settings.stromTariff = document.getElementById('strom-tariff-select').value;
    appState.settings.gasTariff = document.getElementById('gas-tariff-select').value;
    appState.settings.gasFaktor = parseFloat(document.getElementById('gas-faktor').value) || 0;
    
    saveAndRerender(); // Verwendet saveAndRerender f√ºr die konsistente Aktualisierung der UI
}

function clearAllData() {
    if (confirm("Sind Sie sicher, dass Sie alle monatlichen Z√§hlerstandsdaten l√∂schen m√∂chten? Die gespeicherten Jahresbilanzen bleiben erhalten.")) {
        appState.entries = []; 
        localStorage.removeItem('energyAppEntries'); 
        render();
        alert("Alle monatlichen Z√§hlerstandsdaten wurden gel√∂scht.");
    }
}

function clearYearlyData() {
    if (confirm("Sind Sie sicher, dass Sie ALLE gespeicherten Jahresbilanzen l√∂schen m√∂chten?")) {
        appState.yearlySummaries = {}; 
        localStorage.removeItem('energyAppYearlySummaries'); 
        
        populateComparisonDropdown(); 
        renderComparison(); 
        
        alert("Alle gespeicherten Jahresbilanzen wurden gel√∂scht.");
    }
}

function recalculateAllEntries() {
    const tempEntries = [];

    if (appState.entries.length === 0) return;

    // Eintr√§ge m√ºssen chronologisch sortiert sein, um die Gas-Tier-Berechnung korrekt durchzuf√ºhren
    const sortedEntries = [...appState.entries].sort((a, b) => a.id.localeCompare(b.id));

    sortedEntries.forEach(entry => {
        const stromTariffKey = appState.settings.stromTariff;
        const gasTariffKey = appState.settings.gasTariff;
        const stromTariffSelected = stromTariffKey !== NO_TARIFF_SELECTED;
        const gasTariffSelected = gasTariffKey !== NO_TARIFF_SELECTED;

        let stromKosten = 0;
        let gasKosten = 0;
        // Verwende immer die gespeicherten Verbrauchswerte zur Neuberechnung
        let stromVerbrauch = entry.strom.verbrauch; 
        let gasVerbrauchM3 = entry.gas.verbrauchM3;
        // NEUE ANPASSUNG: Gasverbrauch KWh wird mit dem aktuellen Faktor NEU berechnet
        let gasVerbrauchKWh = entry.gas.verbrauchM3 * appState.settings.gasFaktor;
        
        // 1. STROM-NEUBERECHNUNG
        if (stromTariffSelected && stromVerbrauch > 0) {
            const stromTariff = TARIFF_DATA.strom[stromTariffKey];
            stromKosten = (stromVerbrauch * stromTariff.arbeitspreis) + (stromTariff.grundpreis / 12);
        } else {
            stromVerbrauch = 0;
        }

        // 2. GAS-NEUBERECHNUNG
        if (gasTariffSelected && gasVerbrauchM3 > 0) {
            const gasTariffData = TARIFF_DATA.gas[gasTariffKey];
            
            gasVerbrauchKWh = gasVerbrauchM3 * appState.settings.gasFaktor;
            
            // Re-Evaluation der Gas-Tier-Stufe basierend auf *bereits neu berechneten* Eintr√§gen
            const currentTotalKWh = tempEntries.reduce((sum, e) => sum + e.gas.verbrauchKWh, 0) + gasVerbrauchKWh;
            const estimatedAnnualKWh = (currentTotalKWh / (tempEntries.length + 1)) * 12;
            const gasTier = gasTariffData.tiers.find(t => estimatedAnnualKWh <= t.bis);
            
            gasKosten = (gasVerbrauchKWh * gasTier.arbeitspreis) + (gasTier.grundpreis / 12);
        } else {
            gasVerbrauchM3 = 0;
            gasVerbrauchKWh = 0;
        }

        const updatedEntry = {
            ...entry,
            // Der gespeicherte Abschlagswert (monthlyPayment) bleibt unver√§ndert!
            strom: { 
                ...entry.strom, 
                kosten: stromKosten,
                verbrauch: stromVerbrauch,
                start: stromTariffSelected ? entry.strom.start : 0,
                end: stromTariffSelected ? entry.strom.end : 0,
            },
            gas: { 
                ...entry.gas, 
                verbrauchKWh: gasVerbrauchKWh, 
                kosten: gasKosten,
                verbrauchM3: gasVerbrauchM3,
                start: gasTariffSelected ? entry.gas.start : 0,
                end: gasTariffSelected ? entry.gas.end : 0,
            },
            totalCosts: stromKosten + gasKosten,
        };
        
        tempEntries.push(updatedEntry);
    });

    appState.entries = tempEntries;
}


function toggleSettings() {
    const settingsContent = document.getElementById('settings-content');
    const chevronIcon = document.getElementById('settings-chevron');
    if (settingsContent.classList.contains('hidden')) {
        settingsContent.classList.remove('hidden');
        chevronIcon.classList.add('rotate-180');
    } else {
        settingsContent.classList.add('hidden');
        chevronIcon.classList.remove('rotate-180');
    }
}

// --- UTILITY FUNCTIONS ---
function applySettingsToUI() {
    document.getElementById('monthly-payment').value = appState.settings.monthlyPayment;
    document.getElementById('gas-faktor').value = appState.settings.gasFaktor;
    document.getElementById('strom-tariff-select').value = appState.settings.stromTariff;
    document.getElementById('gas-tariff-select').value = appState.settings.gasTariff;
}

/**
 * Speichert den Zustand und triggert das Rendern der UI.
 * F√ºhrt alle Rendering-Schritte sofort und synchron aus.
 */
function saveAndRerender() {
    saveStateToLocalStorage();
    // Ruft alle Render-Funktionen auf und erzwingt die UI-Aktualisierung
    render(); 
}

function formatCurrency(value, useAbs = false) {
    const val = useAbs ? Math.abs(value) : value;
    return val.toLocaleString('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2 });
}

function showError(message) {
    const errorEl = document.getElementById('error-message');
    errorEl.textContent = message;
    errorEl.classList.remove('hidden');
}

function hideError() {
    const errorEl = document.getElementById('error-message');
    errorEl.classList.add('hidden');
}

</script>
</body>
</html>
